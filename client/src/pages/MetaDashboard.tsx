import { useState, useEffect } from 'react';\nimport { useQuery } from '@tanstack/react-query';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Badge } from '@/components/ui/badge';\nimport { Button } from '@/components/ui/button';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Alert, AlertDescription } from '@/components/ui/alert';\nimport { Skeleton } from '@/components/ui/skeleton';\nimport { \n  TrendingUp, \n  DollarSign, \n  Eye, \n  MousePointer, \n  ShoppingCart, \n  Users, \n  Target,\n  AlertCircle,\n  BarChart3,\n  PieChart\n} from 'lucide-react';\nimport { useLocation } from 'wouter';\n\ninterface MetaDashboardData {\n  account: {\n    id: string;\n    name: string;\n    currency: string;\n  };\n  period: {\n    start: string;\n    end: string;\n    days: number;\n  };\n  overview: {\n    totalSpend: number;\n    totalImpressions: number;\n    totalClicks: number;\n    totalPurchases: number;\n    totalRevenue: number;\n  };\n  metrics: {\n    ctr: number;\n    cpc: number;\n    roas: number;\n    atcRate: number;\n    pfRate: number;\n  };\n  funnel: {\n    impressions: number;\n    clicks: number;\n    viewContent: number;\n    addToCart: number;\n    purchases: number;\n  };\n}\n\ninterface BusinessMetrics {\n  type: string;\n  metrics: Record<string, number>;\n  breakdown: Record<string, number>;\n}\n\nexport default function MetaDashboard() {\n  const [, setLocation] = useLocation();\n  const [businessType, setBusinessType] = useState<string>('ecommerce');\n  const [needsAuth, setNeedsAuth] = useState(false);\n\n  // 獲取 Meta 儀表板統計數據\n  const { \n    data: dashboardData, \n    isLoading: dashboardLoading, \n    error: dashboardError,\n    refetch: refetchDashboard\n  } = useQuery<{ success: boolean; data: MetaDashboardData }>({ \n    queryKey: ['/api/meta/dashboard-stats'],\n    retry: false\n  });\n\n  // 獲取業務指標\n  const { \n    data: businessData, \n    isLoading: businessLoading,\n    refetch: refetchBusiness\n  } = useQuery<{ success: boolean; data: BusinessMetrics }>({ \n    queryKey: ['/api/meta/business-metrics', businessType],\n    enabled: !!dashboardData?.success && !needsAuth\n  });\n\n  // 處理認證錯誤\n  useEffect(() => {\n    if (dashboardError && (dashboardError as any)?.response?.status === 400) {\n      const errorData = (dashboardError as any)?.response?.data;\n      if (errorData?.needsFacebookAuth) {\n        setNeedsAuth(true);\n      }\n    }\n  }, [dashboardError]);\n\n  // 連接 Facebook 廣告帳戶\n  const handleConnectFacebook = () => {\n    setLocation('/fbaudit');\n  };\n\n  // 如果需要 Facebook 認證\n  if (needsAuth || (dashboardError && (dashboardError as any)?.response?.data?.needsFacebookAuth)) {\n    return (\n      <div className=\"min-h-screen bg-gray-50 dark:bg-gray-900 p-6\">\n        <div className=\"max-w-4xl mx-auto\">\n          <div className=\"text-center space-y-6\">\n            <div className=\"mx-auto w-16 h-16 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center\">\n              <Target className=\"w-8 h-8 text-blue-600 dark:text-blue-400\" />\n            </div>\n            \n            <div className=\"space-y-2\">\n              <h1 className=\"text-3xl font-bold text-gray-900 dark:text-white\">\n                Meta 廣告儀表板\n              </h1>\n              <p className=\"text-gray-600 dark:text-gray-400\">\n                連接您的 Facebook 廣告帳戶以查看詳細的廣告數據分析\n              </p>\n            </div>\n            \n            <Alert className=\"max-w-md mx-auto\">\n              <AlertCircle className=\"h-4 w-4\" />\n              <AlertDescription>\n                請先連接您的 Facebook 廣告帳戶以開始使用儀表板功能\n              </AlertDescription>\n            </Alert>\n            \n            <Button \n              onClick={handleConnectFacebook}\n              className=\"bg-blue-600 hover:bg-blue-700 text-white\"\n              size=\"lg\"\n            >\n              連接 Facebook 廣告帳戶\n            </Button>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  // 載入中狀態\n  if (dashboardLoading) {\n    return (\n      <div className=\"min-h-screen bg-gray-50 dark:bg-gray-900 p-6\">\n        <div className=\"max-w-7xl mx-auto space-y-6\">\n          <div className=\"space-y-2\">\n            <Skeleton className=\"h-8 w-64\" />\n            <Skeleton className=\"h-4 w-96\" />\n          </div>\n          \n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6\">\n            {[1, 2, 3, 4].map((i) => (\n              <Card key={i}>\n                <CardHeader className=\"pb-2\">\n                  <Skeleton className=\"h-4 w-20\" />\n                  <Skeleton className=\"h-8 w-24\" />\n                </CardHeader>\n                <CardContent>\n                  <Skeleton className=\"h-4 w-16\" />\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  // 錯誤狀態\n  if (dashboardError) {\n    return (\n      <div className=\"min-h-screen bg-gray-50 dark:bg-gray-900 p-6\">\n        <div className=\"max-w-4xl mx-auto\">\n          <Alert className=\"border-red-200 bg-red-50 dark:bg-red-900/20\">\n            <AlertCircle className=\"h-4 w-4 text-red-600\" />\n            <AlertDescription className=\"text-red-800 dark:text-red-300\">\n              載入 Meta 廣告數據時發生錯誤。請檢查您的網路連接或稍後再試。\n            </AlertDescription>\n          </Alert>\n          \n          <div className=\"mt-6 text-center\">\n            <Button onClick={() => refetchDashboard()}>重新載入</Button>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  const data = dashboardData?.data;\n  if (!data) return null;\n\n  const formatCurrency = (amount: number) => {\n    return new Intl.NumberFormat('zh-TW', {\n      style: 'currency',\n      currency: data.account.currency || 'TWD'\n    }).format(amount);\n  };\n\n  const formatNumber = (num: number) => {\n    return new Intl.NumberFormat('zh-TW').format(num);\n  };\n\n  const formatPercentage = (num: number) => {\n    return `${num.toFixed(2)}%`;\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gray-50 dark:bg-gray-900 p-6\">\n      <div className=\"max-w-7xl mx-auto space-y-6\">\n        {/* 頁面標題 */}\n        <div className=\"flex items-center justify-between\">\n          <div className=\"space-y-1\">\n            <h1 className=\"text-3xl font-bold text-gray-900 dark:text-white\">\n              Meta 廣告儀表板\n            </h1>\n            <p className=\"text-gray-600 dark:text-gray-400\">\n              {data.account.name} • {data.period.start} 至 {data.period.end} ({data.period.days} 天)\n            </p>\n          </div>\n          \n          <div className=\"flex items-center space-x-4\">\n            <Select value={businessType} onValueChange={setBusinessType}>\n              <SelectTrigger className=\"w-40\">\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"ecommerce\">電商銷售</SelectItem>\n                <SelectItem value=\"consultation\">線上諮詢</SelectItem>\n                <SelectItem value=\"lead_generation\">潛客開發</SelectItem>\n              </SelectContent>\n            </Select>\n            \n            <Button onClick={() => refetchDashboard()} variant=\"outline\">\n              重新載入\n            </Button>\n          </div>\n        </div>\n\n        {/* 核心指標卡片 */}\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6\">\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">總花費</CardTitle>\n              <DollarSign className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">{formatCurrency(data.overview.totalSpend)}</div>\n              <p className=\"text-xs text-muted-foreground\">\n                過去 {data.period.days} 天\n              </p>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">曝光次數</CardTitle>\n              <Eye className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">{formatNumber(data.overview.totalImpressions)}</div>\n              <p className=\"text-xs text-muted-foreground\">\n                CTR: {formatPercentage(data.metrics.ctr)}\n              </p>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">點擊次數</CardTitle>\n              <MousePointer className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">{formatNumber(data.overview.totalClicks)}</div>\n              <p className=\"text-xs text-muted-foreground\">\n                CPC: {formatCurrency(data.metrics.cpc)}\n              </p>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">廣告投資報酬率</CardTitle>\n              <TrendingUp className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">{data.metrics.roas.toFixed(2)}x</div>\n              <p className=\"text-xs text-muted-foreground\">\n                收入: {formatCurrency(data.overview.totalRevenue)}\n              </p>\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* 詳細分析區塊 */}\n        <Tabs defaultValue=\"funnel\" className=\"space-y-6\">\n          <TabsList className=\"grid w-full grid-cols-3\">\n            <TabsTrigger value=\"funnel\">轉換漏斗</TabsTrigger>\n            <TabsTrigger value=\"business\">業務指標</TabsTrigger>\n            <TabsTrigger value=\"performance\">效果分析</TabsTrigger>\n          </TabsList>\n\n          {/* 轉換漏斗 */}\n          <TabsContent value=\"funnel\" className=\"space-y-6\">\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center space-x-2\">\n                  <BarChart3 className=\"h-5 w-5\" />\n                  <span>廣告轉換漏斗</span>\n                </CardTitle>\n                <CardDescription>\n                  從曝光到購買的完整轉換流程\n                </CardDescription>\n              </CardHeader>\n              <CardContent>\n                <div className=\"space-y-4\">\n                  {[\n                    { label: '曝光', value: data.funnel.impressions, icon: Eye },\n                    { label: '點擊', value: data.funnel.clicks, icon: MousePointer },\n                    { label: '瀏覽商品', value: data.funnel.viewContent, icon: Users },\n                    { label: '加入購物車', value: data.funnel.addToCart, icon: ShoppingCart },\n                    { label: '完成購買', value: data.funnel.purchases, icon: Target }\n                  ].map((step, index) => {\n                    const Icon = step.icon;\n                    const prevStep = index > 0 ? [\n                      data.funnel.impressions,\n                      data.funnel.clicks,\n                      data.funnel.viewContent,\n                      data.funnel.addToCart,\n                      data.funnel.purchases\n                    ][index - 1] : null;\n                    const conversionRate = prevStep ? (step.value / prevStep * 100) : 100;\n                    \n                    return (\n                      <div key={step.label} className=\"flex items-center justify-between p-4 border rounded-lg\">\n                        <div className=\"flex items-center space-x-3\">\n                          <Icon className=\"h-5 w-5 text-blue-600\" />\n                          <span className=\"font-medium\">{step.label}</span>\n                        </div>\n                        <div className=\"text-right\">\n                          <div className=\"font-bold\">{formatNumber(step.value)}</div>\n                          {index > 0 && (\n                            <div className=\"text-sm text-muted-foreground\">\n                              {formatPercentage(conversionRate)}\n                            </div>\n                          )}\n                        </div>\n                      </div>\n                    );\n                  })}\n                </div>\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n          {/* 業務指標 */}\n          <TabsContent value=\"business\" className=\"space-y-6\">\n            {businessLoading ? (\n              <Card>\n                <CardContent className=\"p-6\">\n                  <div className=\"space-y-4\">\n                    <Skeleton className=\"h-4 w-full\" />\n                    <Skeleton className=\"h-4 w-3/4\" />\n                    <Skeleton className=\"h-4 w-1/2\" />\n                  </div>\n                </CardContent>\n              </Card>\n            ) : businessData?.data ? (\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"flex items-center space-x-2\">\n                    <PieChart className=\"h-5 w-5\" />\n                    <span>\n                      {businessType === 'ecommerce' ? '電商' : \n                       businessType === 'consultation' ? '諮詢' : '潛客開發'}\n                      專用指標\n                    </span>\n                  </CardTitle>\n                  <CardDescription>\n                    針對 {businessType === 'ecommerce' ? '電商業務' : \n                           businessType === 'consultation' ? '諮詢服務' : '潛客開發'} 的關鍵指標分析\n                  </CardDescription>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n                    {Object.entries(businessData.data.metrics).map(([key, value]) => {\n                      const metricLabels: Record<string, string> = {\n                        atcRate: '加購率 (ATC%)',\n                        pfRate: '結帳率 (PF%)',\n                        aov: '平均訂單價值',\n                        costPerPurchase: '每次購買成本',\n                        roas: '廣告投資報酬率',\n                        costPerMessaging: '每次對話成本',\n                        messagingRate: '對話轉換率',\n                        estimatedConversations: '預估對話數',\n                        costPerLead: '每個潛客成本',\n                        leadRate: '潛客轉換率',\n                        estimatedLeads: '預估潛客數'\n                      };\n                      \n                      return (\n                        <div key={key} className=\"p-4 border rounded-lg\">\n                          <div className=\"text-sm text-muted-foreground\">\n                            {metricLabels[key] || key}\n                          </div>\n                          <div className=\"text-2xl font-bold\">\n                            {key.includes('Rate') || key.includes('率') ? \n                              formatPercentage(value as number) :\n                              key.includes('cost') || key.includes('成本') || key === 'aov' ?\n                                formatCurrency(value as number) :\n                                key === 'roas' ?\n                                  `${(value as number).toFixed(2)}x` :\n                                  formatNumber(value as number)\n                            }\n                          </div>\n                        </div>\n                      );\n                    })}\n                  </div>\n                </CardContent>\n              </Card>\n            ) : (\n              <Alert>\n                <AlertCircle className=\"h-4 w-4\" />\n                <AlertDescription>\n                  無法載入業務指標數據，請稍後再試。\n                </AlertDescription>\n              </Alert>\n            )}\n          </TabsContent>\n\n          {/* 效果分析 */}\n          <TabsContent value=\"performance\" className=\"space-y-6\">\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n              <Card>\n                <CardHeader>\n                  <CardTitle>關鍵指標表現</CardTitle>\n                  <CardDescription>\n                    廣告效果核心指標分析\n                  </CardDescription>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"space-y-4\">\n                    <div className=\"flex justify-between items-center\">\n                      <span>點擊率 (CTR)</span>\n                      <Badge variant={data.metrics.ctr > 1 ? \"default\" : \"secondary\"}>\n                        {formatPercentage(data.metrics.ctr)}\n                      </Badge>\n                    </div>\n                    <div className=\"flex justify-between items-center\">\n                      <span>單次點擊成本 (CPC)</span>\n                      <Badge variant={data.metrics.cpc < 10 ? \"default\" : \"secondary\"}>\n                        {formatCurrency(data.metrics.cpc)}\n                      </Badge>\n                    </div>\n                    <div className=\"flex justify-between items-center\">\n                      <span>廣告投資報酬率 (ROAS)</span>\n                      <Badge variant={data.metrics.roas > 2 ? \"default\" : \"secondary\"}>\n                        {data.metrics.roas.toFixed(2)}x\n                      </Badge>\n                    </div>\n                    {businessType === 'ecommerce' && (\n                      <>\n                        <div className=\"flex justify-between items-center\">\n                          <span>加購率 (ATC%)</span>\n                          <Badge variant={data.metrics.atcRate > 5 ? \"default\" : \"secondary\"}>\n                            {formatPercentage(data.metrics.atcRate)}\n                          </Badge>\n                        </div>\n                        <div className=\"flex justify-between items-center\">\n                          <span>結帳率 (PF%)</span>\n                          <Badge variant={data.metrics.pfRate > 15 ? \"default\" : \"secondary\"}>\n                            {formatPercentage(data.metrics.pfRate)}\n                          </Badge>\n                        </div>\n                      </>\n                    )}\n                  </div>\n                </CardContent>\n              </Card>\n              \n              <Card>\n                <CardHeader>\n                  <CardTitle>優化建議</CardTitle>\n                  <CardDescription>\n                    基於當前數據的改善建議\n                  </CardDescription>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"space-y-3\">\n                    {data.metrics.ctr < 1 && (\n                      <Alert>\n                        <AlertCircle className=\"h-4 w-4\" />\n                        <AlertDescription>\n                          點擊率較低，建議優化廣告創意和受眾定位\n                        </AlertDescription>\n                      </Alert>\n                    )}\n                    {data.metrics.roas < 2 && (\n                      <Alert>\n                        <AlertCircle className=\"h-4 w-4\" />\n                        <AlertDescription>\n                          ROAS 偏低，建議檢視轉換追蹤和優化著陸頁\n                        </AlertDescription>\n                      </Alert>\n                    )}\n                    {businessType === 'ecommerce' && data.metrics.atcRate < 5 && (\n                      <Alert>\n                        <AlertCircle className=\"h-4 w-4\" />\n                        <AlertDescription>\n                          加購率偏低，建議優化商品頁面和定價策略\n                        </AlertDescription>\n                      </Alert>\n                    )}\n                    {(data.metrics.ctr >= 1 && data.metrics.roas >= 2) && (\n                      <Alert className=\"border-green-200 bg-green-50 dark:bg-green-900/20\">\n                        <TrendingUp className=\"h-4 w-4 text-green-600\" />\n                        <AlertDescription className=\"text-green-800 dark:text-green-300\">\n                          廣告表現良好！可考慮增加預算或擴展受眾\n                        </AlertDescription>\n                      </Alert>\n                    )}\n                  </div>\n                </CardContent>\n              </Card>\n            </div>\n          </TabsContent>\n        </Tabs>\n      </div>\n    </div>\n  );\n}\n