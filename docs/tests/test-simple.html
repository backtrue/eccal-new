<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç°¡å–®æ¸¬è©¦é é¢</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .card {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .btn {
            display: inline-block;
            padding: 10px 20px;
            margin: 10px 5px;
            background: #4CAF50;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            border: none;
            cursor: pointer;
        }
        
        .btn:hover {
            background: #45a049;
        }
        
        .btn-red {
            background: #f44336;
        }
        
        .btn-red:hover {
            background: #da190b;
        }
        
        .log {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid #4CAF50;
            background: #f8f9fa;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="card">
        <h1>ğŸ”§ ç°¡å–®æ¸¬è©¦é é¢</h1>
        <p>é¿å…è¤‡é›œèªæ³•çš„åŸºæœ¬æ¸¬è©¦</p>
    </div>
    
    <div class="card">
        <h2>ç‹€æ…‹æª¢æŸ¥</h2>
        <div class="status">
            <h3>URL æª¢æŸ¥</h3>
            <div id="url-check">æª¢æŸ¥ä¸­...</div>
        </div>
        <div class="status">
            <h3>æœ¬åœ°å­˜å„²</h3>
            <div id="storage-check">æª¢æŸ¥ä¸­...</div>
        </div>
        <div class="status">
            <h3>èªè­‰ç‹€æ…‹</h3>
            <div id="auth-check">æª¢æŸ¥ä¸­...</div>
        </div>
    </div>
    
    <div class="card">
        <h2>æ“ä½œæŒ‰éˆ•</h2>
        <button class="btn" onclick="testGoogleLogin()">Google ç™»å…¥</button>
        <button class="btn" onclick="testToken()">æ¸¬è©¦ Token</button>
        <button class="btn btn-red" onclick="clearData()">æ¸…é™¤è³‡æ–™</button>
    </div>
    
    <div id="user-info" class="card hidden">
        <h2>ç”¨æˆ¶è³‡è¨Š</h2>
        <div id="user-details"></div>
    </div>
    
    <div class="card">
        <h2>æ—¥èªŒ</h2>
        <div id="log-output" class="log"></div>
    </div>

    <script>
        // åŸºæœ¬è®Šæ•¸
        var currentToken = null;
        var currentUser = null;
        var logElement = null;
        
        // æ—¥èªŒå‡½æ•¸
        function addLog(message) {
            var time = new Date().toLocaleTimeString();
            var entry = '[' + time + '] ' + message + '\n';
            
            if (logElement) {
                logElement.textContent += entry;
                logElement.scrollTop = logElement.scrollHeight;
            }
            
            console.log('[LOG] ' + message);
        }
        
        // åˆå§‹åŒ–
        function init() {
            logElement = document.getElementById('log-output');
            addLog('ç³»çµ±å•Ÿå‹•');
            
            checkURL();
            checkStorage();
            checkAuth();
        }
        
        // æª¢æŸ¥ URL
        function checkURL() {
            var params = new URLSearchParams(window.location.search);
            var success = params.get('auth_success');
            var token = params.get('token');
            var error = params.get('auth_error');
            
            var urlElement = document.getElementById('url-check');
            
            if (success === 'true') {
                urlElement.innerHTML = 'âœ… èªè­‰æˆåŠŸ';
                if (token) {
                    currentToken = token;
                    addLog('å¾ URL ç²å– Token');
                }
            } else if (error === 'true') {
                urlElement.innerHTML = 'âŒ èªè­‰å¤±æ•—';
                addLog('URL é¡¯ç¤ºèªè­‰å¤±æ•—');
            } else {
                urlElement.innerHTML = 'âšª ç„¡èªè­‰åƒæ•¸';
                addLog('URL ç„¡èªè­‰åƒæ•¸');
            }
        }
        
        // æª¢æŸ¥å­˜å„²
        function checkStorage() {
            var token = localStorage.getItem('eccal_auth_token');
            var user = localStorage.getItem('eccal_auth_user');
            
            var storageElement = document.getElementById('storage-check');
            
            if (token) {
                currentToken = token;
                storageElement.innerHTML = 'âœ… æœ‰å­˜å„²çš„ Token';
                addLog('æ‰¾åˆ°æœ¬åœ° Token');
            } else {
                storageElement.innerHTML = 'âšª ç„¡å­˜å„²çš„ Token';
                addLog('æ²’æœ‰æœ¬åœ° Token');
            }
        }
        
        // æª¢æŸ¥èªè­‰
        function checkAuth() {
            var authElement = document.getElementById('auth-check');
            
            if (currentToken) {
                authElement.innerHTML = 'ğŸ”„ é©—è­‰ä¸­...';
                addLog('é–‹å§‹é©—è­‰ Token');
                verifyToken(currentToken);
            } else {
                authElement.innerHTML = 'âšª æœªèªè­‰';
                addLog('ç„¡ Token å¯é©—è­‰');
            }
        }
        
        // é©—è­‰ Token
        function verifyToken(token) {
            addLog('ç™¼é€é©—è­‰è«‹æ±‚');
            
            var xhr = new XMLHttpRequest();
            xhr.open('POST', 'https://eccal.thinkwithblack.com/api/sso/verify-token', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.setRequestHeader('Origin', window.location.origin);
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    addLog('æ”¶åˆ°é©—è­‰éŸ¿æ‡‰: ' + xhr.status);
                    
                    if (xhr.status === 200) {
                        try {
                            var data = JSON.parse(xhr.responseText);
                            if (data.valid && data.user) {
                                addLog('Token æœ‰æ•ˆ');
                                currentUser = data.user;
                                showUser(data.user);
                                document.getElementById('auth-check').innerHTML = 'âœ… å·²èªè­‰';
                                
                                // å„²å­˜è³‡æ–™
                                localStorage.setItem('eccal_auth_token', token);
                                localStorage.setItem('eccal_auth_user', JSON.stringify(data.user));
                            } else {
                                addLog('Token ç„¡æ•ˆ');
                                document.getElementById('auth-check').innerHTML = 'âŒ Token ç„¡æ•ˆ';
                            }
                        } catch (e) {
                            addLog('è§£æéŸ¿æ‡‰å¤±æ•—: ' + e.message);
                            document.getElementById('auth-check').innerHTML = 'âŒ è§£æå¤±æ•—';
                        }
                    } else {
                        addLog('é©—è­‰å¤±æ•—: ' + xhr.status);
                        document.getElementById('auth-check').innerHTML = 'âŒ é©—è­‰å¤±æ•—';
                    }
                }
            };
            
            xhr.send(JSON.stringify({ token: token }));
        }
        
        // é¡¯ç¤ºç”¨æˆ¶
        function showUser(user) {
            var userSection = document.getElementById('user-info');
            var userDetails = document.getElementById('user-details');
            
            var html = '<h3>ç”¨æˆ¶è³‡è¨Š</h3>';
            html += '<p><strong>Email:</strong> ' + user.email + '</p>';
            html += '<p><strong>å§“å:</strong> ' + (user.name || 'æœªè¨­å®š') + '</p>';
            html += '<p><strong>æœƒå“¡:</strong> ' + (user.membership || 'free') + '</p>';
            html += '<p><strong>é»æ•¸:</strong> ' + (user.credits || 0) + '</p>';
            html += '<p><strong>ID:</strong> ' + (user.sub || user.id) + '</p>';
            
            userDetails.innerHTML = html;
            userSection.classList.remove('hidden');
            
            addLog('ç”¨æˆ¶è³‡è¨Šé¡¯ç¤ºå®Œæˆ');
        }
        
        // Google ç™»å…¥
        function testGoogleLogin() {
            addLog('å•Ÿå‹• Google ç™»å…¥');
            
            var returnUrl = encodeURIComponent(window.location.href);
            var url = 'https://eccal.thinkwithblack.com/api/auth/google-sso?returnTo=' + returnUrl + '&service=audai';
            
            addLog('è·³è½‰åˆ°: ' + url);
            window.location.href = url;
        }
        
        // æ¸¬è©¦ Token
        function testToken() {
            var token = localStorage.getItem('eccal_auth_token');
            if (token) {
                addLog('æ¸¬è©¦æœ¬åœ° Token');
                verifyToken(token);
            } else {
                addLog('æ²’æœ‰æœ¬åœ° Token');
                alert('æ²’æœ‰æœ¬åœ° Tokenï¼Œè«‹å…ˆç™»å…¥');
            }
        }
        
        // æ¸…é™¤è³‡æ–™
        function clearData() {
            localStorage.removeItem('eccal_auth_token');
            localStorage.removeItem('eccal_auth_user');
            currentToken = null;
            currentUser = null;
            
            document.getElementById('user-info').classList.add('hidden');
            
            addLog('è³‡æ–™å·²æ¸…é™¤');
            
            // æ¸…ç† URL
            var url = new URL(window.location);
            url.searchParams.delete('auth_success');
            url.searchParams.delete('token');
            url.searchParams.delete('user_id');
            url.searchParams.delete('auth_error');
            url.searchParams.delete('error_message');
            window.history.replaceState({}, document.title, url.toString());
            
            // é‡æ–°è¼‰å…¥
            setTimeout(function() {
                location.reload();
            }, 1000);
        }
        
        // é é¢è¼‰å…¥å®Œæˆ
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>