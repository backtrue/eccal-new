<!DOCTYPE html>
<html>
<head>
    <title>èªè­‰ä¿®å¾©é©—è­‰æ¸¬è©¦</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .success-alert { background: #4caf50; color: white; padding: 15px; border-radius: 8px; margin: 15px 0; }
        .user-card { border: 2px solid #4caf50; padding: 15px; margin: 10px 0; border-radius: 8px; }
        .btn { background: #4caf50; color: white; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; margin: 3px; }
        .btn-test { background: #1976d2; }
        .result { padding: 8px; border-radius: 4px; margin: 5px 0; font-family: monospace; }
        .success { background: #c8e6c9; color: #388e3c; }
        .error { background: #ffcdd2; color: #d32f2f; }
        .info { background: #e3f2fd; color: #1976d2; }
    </style>
</head>
<body>
    <div class="container">
        <div class="success-alert">
            <h1>ğŸ‰ èªè­‰å•é¡Œå·²ä¿®å¾©ï¼</h1>
            <p>Google Access Token æ ¼å¼å•é¡Œå·²è§£æ±ºï¼Œç¾åœ¨æ¸¬è©¦èªè­‰åŠŸèƒ½</p>
        </div>
        
        <button class="btn" onclick="testAllUsers()">ğŸ” æ¸¬è©¦æ‰€æœ‰ç”¨æˆ¶èªè­‰</button>
        <button class="btn btn-test" onclick="testOAuthFlow()">ğŸ”— æ¸¬è©¦ OAuth æµç¨‹</button>
        
        <div id="globalResult" class="result info">æº–å‚™æ¸¬è©¦èªè­‰ä¿®å¾©æ•ˆæœ...</div>
        
        <div class="user-card">
            <h3>âœ… jamesboyphs@gmail.com (å·²ä¿®å¾©)</h3>
            <div id="james-result" class="result"></div>
        </div>
        
        <div class="user-card">
            <h3>â³ kaoic08@gmail.com (ä¿®å¾©ä¸­)</h3>
            <div id="kaoic-result" class="result"></div>
        </div>
        
        <div class="user-card">
            <h3>â³ pin10andy@gmail.com (ä¿®å¾©ä¸­)</h3>
            <div id="pin10andy-result" class="result"></div>
        </div>
        
        <div class="user-card">
            <h3>â³ ming2635163@gmail.com (ä¿®å¾©ä¸­)</h3>
            <div id="ming-result" class="result"></div>
        </div>
        
        <div id="testSummary" style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px;"></div>
    </div>

    <script>
        const users = [
            { email: 'jamesboyphs@gmail.com', id: 'james', status: 'fixed' },
            { email: 'kaoic08@gmail.com', id: 'kaoic', status: 'pending' },
            { email: 'pin10andy@gmail.com', id: 'pin10andy', status: 'pending' },
            { email: 'ming2635163@gmail.com', id: 'ming', status: 'pending' }
        ];
        
        function setResult(userId, message, type = 'info') {
            const element = document.getElementById(userId + '-result');
            element.innerHTML = message;
            element.className = `result ${type}`;
        }
        
        function setGlobalResult(message, type = 'info') {
            const element = document.getElementById('globalResult');
            element.innerHTML = message;
            element.className = `result ${type}`;
        }
        
        async function testUserAuthentication(email, userId) {
            setResult(userId, `æ¸¬è©¦ä¸­ï¼šæª¢æŸ¥ ${email} çš„èªè­‰ç‹€æ…‹...`, 'info');
            
            try {
                // æ¸¬è©¦èªè­‰ API
                const response = await fetch('/api/user/me', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const userData = await response.json();
                    if (userData.email === email) {
                        setResult(userId, `âœ… èªè­‰æˆåŠŸï¼${email} å¯ä»¥æ­£å¸¸ç™»å…¥`, 'success');
                        return { email, success: true, message: 'èªè­‰æ­£å¸¸' };
                    } else {
                        setResult(userId, `âš ï¸ èªè­‰éŸ¿æ‡‰æ­£å¸¸ï¼Œä½†ç”¨æˆ¶ä¸åŒ¹é…`, 'info');
                        return { email, success: false, message: 'ç”¨æˆ¶ä¸åŒ¹é…' };
                    }
                } else {
                    const errorText = await response.text();
                    if (errorText.includes('Authentication required')) {
                        setResult(userId, `ğŸ”“ éœ€è¦é‡æ–°ç™»å…¥ï¼ˆé€™æ˜¯æ­£å¸¸çš„ï¼‰`, 'info');
                        return { email, success: true, message: 'éœ€è¦é‡æ–°ç™»å…¥ï¼ˆæ­£å¸¸ï¼‰' };
                    } else {
                        setResult(userId, `âŒ èªè­‰å¤±æ•—ï¼š${errorText.substring(0, 50)}`, 'error');
                        return { email, success: false, message: errorText };
                    }
                }
            } catch (error) {
                setResult(userId, `ğŸ’¥ æ¸¬è©¦éŒ¯èª¤ï¼š${error.message}`, 'error');
                return { email, success: false, message: error.message };
            }
        }
        
        async function testOAuthFlow() {
            setGlobalResult('æ¸¬è©¦ OAuth æµç¨‹...', 'info');
            
            try {
                const response = await fetch('/api/auth/google', {
                    method: 'GET',
                    redirect: 'manual'
                });
                
                if (response.status === 302) {
                    const location = response.headers.get('Location');
                    if (location && location.includes('accounts.google.com')) {
                        setGlobalResult('âœ… OAuth æµç¨‹æ­£å¸¸ - å¯ä»¥é‡å®šå‘åˆ° Google', 'success');
                    } else {
                        setGlobalResult(`âš ï¸ OAuth é‡å®šå‘ç•°å¸¸ï¼š${location}`, 'info');
                    }
                } else {
                    setGlobalResult(`âŒ OAuth ç«¯é»éŸ¿æ‡‰ç•°å¸¸ï¼š${response.status}`, 'error');
                }
            } catch (error) {
                setGlobalResult(`ğŸ’¥ OAuth æ¸¬è©¦éŒ¯èª¤ï¼š${error.message}`, 'error');
            }
        }
        
        async function testAllUsers() {
            setGlobalResult('é–‹å§‹æ¸¬è©¦æ‰€æœ‰ç”¨æˆ¶çš„èªè­‰ç‹€æ…‹...', 'info');
            
            const results = [];
            
            for (const user of users) {
                const result = await testUserAuthentication(user.email, user.id);
                results.push(result);
                
                // çŸ­æš«å»¶é²
                await new Promise(resolve => setTimeout(resolve, 300));
            }
            
            // ç”Ÿæˆç¸½çµ
            const successCount = results.filter(r => r.success).length;
            const failCount = results.length - successCount;
            
            let summaryHTML = `
                <h3>ğŸ¯ èªè­‰ä¿®å¾©é©—è­‰å ±å‘Š</h3>
                <p><strong>æ¸¬è©¦æ™‚é–“ï¼š</strong>${new Date().toLocaleString()}</p>
                <p><strong>æ¸¬è©¦ç”¨æˆ¶ï¼š</strong>${results.length} å€‹</p>
                <p><strong>èªè­‰æ­£å¸¸ï¼š</strong>${successCount} å€‹</p>
                <p><strong>éœ€è¦è™•ç†ï¼š</strong>${failCount} å€‹</p>
            `;
            
            if (failCount === 0) {
                summaryHTML += `<p style="color: green; font-weight: bold;">ğŸ‰ æ‰€æœ‰ç”¨æˆ¶çš„èªè­‰å•é¡Œéƒ½å·²è§£æ±ºï¼</p>`;
                setGlobalResult('ğŸ‰ èªè­‰ä¿®å¾©æˆåŠŸï¼æ‰€æœ‰ç”¨æˆ¶éƒ½å¯ä»¥æ­£å¸¸ä½¿ç”¨ç³»çµ±', 'success');
            } else {
                summaryHTML += `<h4>éœ€è¦é€²ä¸€æ­¥è™•ç†çš„ç”¨æˆ¶ï¼š</h4><ul>`;
                results.filter(r => !r.success).forEach(r => {
                    summaryHTML += `<li>${r.email}: ${r.message}</li>`;
                });
                summaryHTML += `</ul>`;
                
                setGlobalResult(`é‚„æœ‰ ${failCount} å€‹ç”¨æˆ¶éœ€è¦è™•ç†`, 'info');
            }
            
            document.getElementById('testSummary').innerHTML = summaryHTML;
        }
        
        // è‡ªå‹•é–‹å§‹æ¸¬è©¦
        window.onload = function() {
            setTimeout(testAllUsers, 1000);
        };
    </script>
</body>
</html>