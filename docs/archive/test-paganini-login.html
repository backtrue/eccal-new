<!DOCTYPE html>
<html>
<head>
    <title>Paganini ç”¨æˆ¶ç™»å…¥æ¸¬è©¦</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .alert { padding: 15px; border-radius: 8px; margin: 15px 0; }
        .error { background: #ffcdd2; color: #d32f2f; }
        .success { background: #c8e6c9; color: #388e3c; }
        .info { background: #e3f2fd; color: #1976d2; }
        .btn { background: #1976d2; color: white; padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; text-decoration: none; display: inline-block; }
        .result { padding: 10px; border-radius: 4px; margin: 10px 0; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ Paganini ç”¨æˆ¶èªè­‰ä¿®å¾©æ¸¬è©¦</h1>
        
        <div class="alert info">
            <strong>å•é¡Œæè¿°ï¼š</strong>
            paganiniplus36@gmail.com åœ¨ Google OAuth ç™»å…¥æ™‚é‡åˆ° "duplicate key value violates unique constraint users_email_key" éŒ¯èª¤
        </div>
        
        <div class="alert success">
            <strong>ä¿®å¾©æªæ–½ï¼š</strong>
            å·²ä¿®æ”¹ upsertUser å‡½æ•¸ä¾†æ­£ç¢ºè™•ç† email å”¯ä¸€æ€§ç´„æŸè¡çª
        </div>
        
        <h3>æ¸¬è©¦æ­¥é©Ÿï¼š</h3>
        <a href="/api/auth/google" class="btn">ğŸ”— æ¸¬è©¦ Google OAuth ç™»å…¥</a>
        <button class="btn" onclick="testUserStatus()">ğŸ“Š æª¢æŸ¥ç”¨æˆ¶ç‹€æ…‹</button>
        <button class="btn" onclick="testAuthFlow()">ğŸ” æ¸¬è©¦èªè­‰æµç¨‹</button>
        
        <div id="result" class="result info">ç­‰å¾…æ¸¬è©¦çµæœ...</div>
        
        <h3>ç”¨æˆ¶ä¿¡æ¯ï¼š</h3>
        <div class="result">
ç”¨æˆ¶ ID: 02888c5d-bee4-4af0-86ae-69d7338504fa
Email: paganiniplus36@gmail.com
ç•¶å‰ç‹€æ…‹: Google Access Token å·²æ¸…é™¤
Token éæœŸæ™‚é–“: 2025-08-15 14:16:33.516
æœ€å¾Œç™»å…¥: 2025-07-30 07:12:17.096
        </div>
    </div>

    <script>
        function setResult(message, type = 'info') {
            const element = document.getElementById('result');
            element.textContent = message;
            element.className = `result ${type}`;
        }
        
        async function testUserStatus() {
            setResult('æª¢æŸ¥ç”¨æˆ¶ç‹€æ…‹ä¸­...', 'info');
            
            try {
                const response = await fetch('/api/user/me', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const user = await response.json();
                    setResult(`âœ… ç”¨æˆ¶ç‹€æ…‹æ­£å¸¸ï¼š
ID: ${user.id}
Email: ${user.email}
æœƒå“¡ç­‰ç´š: ${user.membershipLevel}
Token éæœŸ: ${user.tokenExpiresAt}`, 'success');
                } else {
                    const error = await response.text();
                    setResult(`âš ï¸ éœ€è¦é‡æ–°ç™»å…¥ï¼š${error}`, 'info');
                }
            } catch (error) {
                setResult(`âŒ æ¸¬è©¦éŒ¯èª¤ï¼š${error.message}`, 'error');
            }
        }
        
        async function testAuthFlow() {
            setResult('æ¸¬è©¦èªè­‰æµç¨‹...', 'info');
            
            try {
                const response = await fetch('/api/auth/google', {
                    method: 'GET',
                    redirect: 'manual'
                });
                
                if (response.status === 302) {
                    const location = response.headers.get('Location');
                    if (location && location.includes('accounts.google.com')) {
                        setResult(`âœ… OAuth æµç¨‹æ­£å¸¸
é‡å®šå‘åœ°å€: ${location.substring(0, 100)}...
ç‹€æ…‹: å¯ä»¥æ­£å¸¸è·³è½‰åˆ° Google ç™»å…¥`, 'success');
                    } else {
                        setResult(`âš ï¸ OAuth é‡å®šå‘ç•°å¸¸ï¼š${location}`, 'info');
                    }
                } else {
                    setResult(`âŒ OAuth ç«¯é»ç•°å¸¸ï¼šHTTP ${response.status}`, 'error');
                }
            } catch (error) {
                setResult(`âŒ èªè­‰æµç¨‹éŒ¯èª¤ï¼š${error.message}`, 'error');
            }
        }
        
        // è‡ªå‹•é–‹å§‹æª¢æŸ¥ç”¨æˆ¶ç‹€æ…‹
        window.onload = function() {
            setTimeout(testUserStatus, 500);
        };
        
        // ç›£è½é é¢çš„ hash è®ŠåŒ–ï¼ˆå¾ OAuth å›èª¿è¿”å›æ™‚ï¼‰
        window.addEventListener('hashchange', function() {
            if (window.location.hash.includes('success')) {
                setResult('ğŸ‰ OAuth ç™»å…¥æˆåŠŸï¼æ­£åœ¨é‡æ–°æª¢æŸ¥ç”¨æˆ¶ç‹€æ…‹...', 'success');
                setTimeout(testUserStatus, 1000);
            }
        });
    </script>
</body>
</html>