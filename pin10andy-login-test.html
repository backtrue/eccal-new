<!DOCTYPE html>
<html>
<head>
    <title>pin10andy@gmail.com å°ˆç”¨èªè­‰æ¸¬è©¦</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .status { background: #e3f2fd; padding: 15px; border-radius: 4px; margin: 10px 0; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e8; color: #2e7d32; }
        button { background: #1976d2; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .critical-box { background: #fff3cd; border: 2px solid #ffc107; padding: 15px; border-radius: 4px; margin: 15px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>pin10andy@gmail.com 500éŒ¯èª¤ä¿®å¾©æ¸¬è©¦</h1>
        
        <div class="critical-box">
            <h3>ğŸš¨ å·²çŸ¥å•é¡Œ</h3>
            <p>âŒ OAuth callback è¿”å› 500 Internal Server Error</p>
            <p>âŒ HAR æª”æ¡ˆé¡¯ç¤º "Authentication failed" éŒ¯èª¤</p>
            <p>âœ… Token å·²å¼·åˆ¶ä¿®å¾©è‡³ 72 å°æ™‚æœ‰æ•ˆ</p>
            <p>âœ… TypeScript éŒ¯èª¤å·²å¾ 12 å€‹æ¸›å°‘åˆ° 1 å€‹</p>
        </div>
        
        <div id="status" class="status">æª¢æŸ¥ä¸­...</div>
        
        <h2>ç·Šæ€¥æ¸¬è©¦</h2>
        <button onclick="testOAuthCallback()">ğŸ”¥ æ¸¬è©¦ OAuth Callback</button>
        <button onclick="testDirectAuth()">ğŸš€ æ¸¬è©¦ç›´æ¥èªè­‰</button>
        <button onclick="testServerHealth()">ğŸ’Š æ¸¬è©¦æœå‹™å™¨å¥åº·</button>
        <button onclick="clearAndRetry()">ğŸ”„ æ¸…é™¤ä¸¦é‡è©¦</button>
        
        <h2>ä¿®å¾©å¾Œç™»å…¥æ¸¬è©¦</h2>
        <p><a href="/api/auth/google?returnTo=%2Fdashboard" target="_blank">ğŸ”— Google OAuth ç™»å…¥ (ä¿®å¾©ç‰ˆ)</a></p>
        <p><a href="/dashboard" target="_blank">ğŸ“Š ç›´æ¥å‰å¾€å„€è¡¨æ¿</a></p>
        
        <div id="results"></div>
        <div id="serverLogs" style="background: #000; color: #0f0; padding: 10px; font-family: monospace; height: 200px; overflow-y: auto; margin-top: 20px;"></div>
    </div>

    <script>
        let logPolling;

        async function testOAuthCallback() {
            document.getElementById('results').innerHTML = '<p>ğŸ”„ æ¸¬è©¦ OAuth callback ä¿®å¾©...</p>';
            
            try {
                // æ¨¡æ“¬ä¸€å€‹ OAuth callback è«‹æ±‚
                const testParams = new URLSearchParams({
                    state: btoa(JSON.stringify({ returnTo: '/dashboard' })),
                    code: 'test_authorization_code',
                    scope: 'email profile'
                });
                
                const response = await fetch(`/api/auth/google/callback?${testParams}`, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                const result = await response.text();
                
                if (response.status === 500) {
                    document.getElementById('results').innerHTML = `
                        <div class="status error">
                            <h3>âŒ ä»ç„¶æœ‰ 500 éŒ¯èª¤</h3>
                            <p>ç‹€æ…‹: ${response.status}</p>
                            <p>å›æ‡‰: ${result}</p>
                        </div>
                    `;
                } else {
                    document.getElementById('results').innerHTML = `
                        <div class="status success">
                            <h3>âœ… OAuth callback ä¿®å¾©æˆåŠŸ</h3>
                            <p>ç‹€æ…‹: ${response.status}</p>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('results').innerHTML = `
                    <div class="status error">
                        <h3>âŒ æ¸¬è©¦å¤±æ•—</h3>
                        <p>éŒ¯èª¤: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        async function testDirectAuth() {
            try {
                const response = await fetch('/api/user/me');
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('status').innerHTML = `
                        <h3>âœ… ç›´æ¥èªè­‰æˆåŠŸï¼</h3>
                        <p>ç”¨æˆ¶: ${data.email}</p>
                        <p>ç©åˆ†: ${data.credits}</p>
                    `;
                    document.getElementById('status').className = 'status success';
                } else {
                    document.getElementById('status').innerHTML = `
                        <h3>âŒ èªè­‰å¤±æ•—</h3>
                        <p>éŒ¯èª¤: ${data.error}</p>
                    `;
                    document.getElementById('status').className = 'status error';
                }
            } catch (error) {
                document.getElementById('status').innerHTML = `
                    <h3>âŒ é€£ç·šéŒ¯èª¤</h3>
                    <p>${error.message}</p>
                `;
                document.getElementById('status').className = 'status error';
            }
        }
        
        async function testServerHealth() {
            try {
                const response = await fetch('/health');
                const data = await response.json();
                
                document.getElementById('status').innerHTML = `
                    <h3>ğŸ“Š æœå‹™å™¨ç‹€æ…‹</h3>
                    <p>ç‹€æ…‹: ${data.status}</p>
                    <p>é‹è¡Œæ™‚é–“: ${Math.floor(data.uptime / 60)} åˆ†é˜</p>
                    <p>è¨˜æ†¶é«”ä½¿ç”¨: ${Math.round(data.memory.used / 1024 / 1024)} MB</p>
                `;
                document.getElementById('status').className = data.status === 'healthy' ? 'status success' : 'status error';
            } catch (error) {
                document.getElementById('status').innerHTML = `âŒ æœå‹™å™¨æª¢æŸ¥å¤±æ•—: ${error.message}`;
                document.getElementById('status').className = 'status error';
            }
        }
        
        function clearAndRetry() {
            localStorage.clear();
            sessionStorage.clear();
            document.cookie.split(";").forEach(cookie => {
                const eqPos = cookie.indexOf("=");
                const name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
                document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/";
            });
            alert('å·²æ¸…é™¤æ‰€æœ‰æœ¬åœ°è³‡æ–™ï¼Œè«‹é‡æ–°æ¸¬è©¦');
            location.reload();
        }
        
        // è‡ªå‹•æª¢æŸ¥ç‹€æ…‹
        testServerHealth();
        
        // æ¯ 10 ç§’æ›´æ–°ä¸€æ¬¡
        setInterval(testServerHealth, 10000);
    </script>
</body>
</html>