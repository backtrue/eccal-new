<!DOCTYPE html>
<html>
<head>
    <title>å¯¦éš›ç™»å…¥æ¸¬è©¦</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .user-test { border: 2px solid #ff5722; padding: 15px; margin: 10px 0; border-radius: 8px; }
        .test-btn { background: #d32f2f; color: white; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; margin: 3px; }
        .logs { background: #000; color: #0f0; padding: 10px; font-family: monospace; height: 200px; overflow-y: auto; margin: 5px 0; font-size: 12px; }
        .status { padding: 8px; border-radius: 4px; margin: 5px 0; }
        .error { background: #ffcdd2; color: #d32f2f; }
        .success { background: #c8e6c9; color: #388e3c; }
        .warning { background: #fff3e0; color: #f57c00; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” å¯¦éš›ç™»å…¥å¤±æ•—æ¸¬è©¦</h1>
        
        <div class="user-test">
            <h3>jamesboyphs@gmail.com</h3>
            <button class="test-btn" onclick="testUserAuth('jamesboyphs@gmail.com')">æ¸¬è©¦èªè­‰</button>
            <button class="test-btn" onclick="simulateOAuth('jamesboyphs@gmail.com')">æ¨¡æ“¬ç™»å…¥</button>
            <div id="james-status" class="status"></div>
            <div id="james-logs" class="logs"></div>
        </div>
        
        <div class="user-test">
            <h3>kaoic08@gmail.com</h3>
            <button class="test-btn" onclick="testUserAuth('kaoic08@gmail.com')">æ¸¬è©¦èªè­‰</button>
            <button class="test-btn" onclick="simulateOAuth('kaoic08@gmail.com')">æ¨¡æ“¬ç™»å…¥</button>
            <div id="kaoic-status" class="status"></div>
            <div id="kaoic-logs" class="logs"></div>
        </div>
        
        <div class="user-test">
            <h3>pin10andy@gmail.com</h3>
            <button class="test-btn" onclick="testUserAuth('pin10andy@gmail.com')">æ¸¬è©¦èªè­‰</button>
            <button class="test-btn" onclick="simulateOAuth('pin10andy@gmail.com')">æ¨¡æ“¬ç™»å…¥</button>
            <div id="pin10andy-status" class="status"></div>
            <div id="pin10andy-logs" class="logs"></div>
        </div>
        
        <div class="user-test">
            <h3>ming2635163@gmail.com</h3>
            <button class="test-btn" onclick="testUserAuth('ming2635163@gmail.com')">æ¸¬è©¦èªè­‰</button>
            <button class="test-btn" onclick="simulateOAuth('ming2635163@gmail.com')">æ¨¡æ“¬ç™»å…¥</button>
            <div id="ming-status" class="status"></div>
            <div id="ming-logs" class="logs"></div>
        </div>
        
        <div style="margin-top: 20px;">
            <button class="test-btn" onclick="testAllUsers()" style="background: #1976d2; font-size: 16px; padding: 12px 20px;">ğŸš€ æ¸¬è©¦æ‰€æœ‰ç”¨æˆ¶</button>
        </div>
        
        <h2>è¨ºæ–·çµæœ</h2>
        <div id="diagnosis"></div>
    </div>

    <script>
        function log(userId, message) {
            const logElement = document.getElementById(userId + '-logs');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function setStatus(userId, message, type = 'warning') {
            const statusElement = document.getElementById(userId + '-status');
            statusElement.innerHTML = message;
            statusElement.className = `status ${type}`;
        }
        
        async function testUserAuth(email) {
            const userId = email.split('@')[0];
            log(userId, `é–‹å§‹æ¸¬è©¦ ${email} çš„èªè­‰ç‹€æ…‹`);
            setStatus(userId, 'æ¸¬è©¦ä¸­...', 'warning');
            
            try {
                // æ¸¬è©¦ç•¶å‰èªè­‰ç‹€æ…‹
                const authResponse = await fetch('/api/user/me', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                log(userId, `èªè­‰æ¸¬è©¦éŸ¿æ‡‰: ${authResponse.status}`);
                
                if (authResponse.ok) {
                    const userData = await authResponse.json();
                    log(userId, `âœ… èªè­‰æˆåŠŸ: ${JSON.stringify(userData)}`);
                    setStatus(userId, 'èªè­‰æˆåŠŸï¼', 'success');
                } else {
                    const errorData = await authResponse.text();
                    log(userId, `âŒ èªè­‰å¤±æ•—: ${errorData}`);
                    setStatus(userId, 'èªè­‰å¤±æ•—', 'error');
                    
                    // å¦‚æœèªè­‰å¤±æ•—ï¼Œå˜—è©¦ä¿®å¾© token
                    await fixUserToken(email, userId);
                }
            } catch (error) {
                log(userId, `ğŸ’¥ èªè­‰æ¸¬è©¦éŒ¯èª¤: ${error.message}`);
                setStatus(userId, 'æ¸¬è©¦éŒ¯èª¤', 'error');
            }
        }
        
        async function fixUserToken(email, userId) {
            log(userId, `å˜—è©¦ä¿®å¾© ${email} çš„ token`);
            
            try {
                const fixResponse = await fetch('/api/admin/fix-user-token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                
                const fixData = await fixResponse.json();
                
                if (fixResponse.ok) {
                    log(userId, `âœ… Token ä¿®å¾©æˆåŠŸ: ${fixData.newExpiry}`);
                } else {
                    log(userId, `âŒ Token ä¿®å¾©å¤±æ•—: ${fixData.error}`);
                }
            } catch (error) {
                log(userId, `ğŸ’¥ Token ä¿®å¾©éŒ¯èª¤: ${error.message}`);
            }
        }
        
        async function simulateOAuth(email) {
            const userId = email.split('@')[0];
            log(userId, `æ¨¡æ“¬ ${email} çš„ OAuth ç™»å…¥æµç¨‹`);
            
            try {
                // æ¸¬è©¦ OAuth åˆå§‹åŒ–
                const oauthResponse = await fetch('/api/auth/google', {
                    method: 'GET',
                    redirect: 'manual'
                });
                
                log(userId, `OAuth åˆå§‹åŒ–: ${oauthResponse.status} ${oauthResponse.statusText}`);
                
                if (oauthResponse.status === 302) {
                    log(userId, 'âœ… OAuth é‡å®šå‘æ­£å¸¸');
                } else {
                    log(userId, 'âŒ OAuth åˆå§‹åŒ–ç•°å¸¸');
                }
            } catch (error) {
                log(userId, `ğŸ’¥ OAuth æ¸¬è©¦éŒ¯èª¤: ${error.message}`);
            }
        }
        
        async function testAllUsers() {
            document.getElementById('diagnosis').innerHTML = '<h3>ğŸ”„ æ­£åœ¨è¨ºæ–·æ‰€æœ‰å•é¡Œç”¨æˆ¶...</h3>';
            
            const users = [
                'jamesboyphs@gmail.com',
                'kaoic08@gmail.com', 
                'pin10andy@gmail.com',
                'ming2635163@gmail.com'
            ];
            
            for (const email of users) {
                await testUserAuth(email);
                await new Promise(resolve => setTimeout(resolve, 1000)); // ç­‰å¾…1ç§’
            }
            
            document.getElementById('diagnosis').innerHTML += '<div class="status success">æ‰€æœ‰ç”¨æˆ¶æ¸¬è©¦å®Œæˆã€‚è«‹æŸ¥çœ‹å„ç”¨æˆ¶çš„è©³ç´°æ—¥èªŒã€‚</div>';
        }
        
        // é é¢è¼‰å…¥æ™‚è‡ªå‹•é–‹å§‹æ¸¬è©¦
        window.onload = function() {
            setTimeout(testAllUsers, 1000);
        };
    </script>
</body>
</html>